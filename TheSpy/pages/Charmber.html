<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charmber</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/charmber.css">
<script type="text/javascript" src="../js/tools.js"></script>
<script type="text/javascript">


    function setSize(){
      var height = window.innerHeight + "px";
      var width = window.innerWidth + "px";
      //var style = "height:" + height + "px;width:" + width + "px";
      //alert(style);
      //$("aaa").setAttribute("style",style);
      //alert(height);

      $("size").style.width = ""+width+"";
      $("size").style.height = ""+height+"";
    }


    function getRoomInfo() {
        var HttpXmlObject = getXmlHttpObject();
        var roomId = getRequestFromUrl("roomId");
        if (HttpXmlObject) {
            var url = "../Controller/GetRoomInfoController.php";
            var data = "";
            if (roomId != "") {
                data = "getRoomInfo=" + roomId;
            } else {
                data = "getRoomInfo=owner";
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        $("room_id").innerHTML = info_obj.roomId;
                        $("room_type").innerHTML = info_obj.roomTpye;
                        $("player_num").innerHTML = info_obj.playerNum;
                        $("is_reveal").innerHTML = info_obj.isRreveal;
                        $("difficulty").innerHTML = info_obj.difficulty;
                        $("stage").value = info_obj.status;
                        var roomInfo = "Room:"+ info_obj.roomId +" ";
                        if(info_obj.isRreveal == "R"){
                            roomInfo += "Identity: reveal ";
                        }else{
                            roomInfo += "Identity: unreveal ";
                        }
                        if(info_obj.difficulty == "E"){
                            roomInfo += "Easy ";
                        }else{
                            roomInfo += "Hard ";
                        }

                        $("room_info").innerHTML = roomInfo;
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }


    function getPlayerList() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/GetPlayersController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "") {
                data = "roomId=" + roomId;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        var players = "<ul>";
                        for (var i = 0; i < info_obj.length; i++) {
                            if(i == 0){
                                $("owner_id").innerHTML = info_obj[0].userId;
                                $("owner_name").innerHTML = info_obj[0].userName;
                            }

                            var img = "pic/welcome.JPG";
                            players += "<li class=\"default\" ";
                            players += "id=\"p_"+info_obj[i].userId + "\" name=\"active_player\">" ;
                            players += "<div>";
                            players += "<img class=\"player\" width=\"34\" height=\"34\" src=\"" + img + "\">";
                            players += "<p class=\"player_name\" id=\"plst_name_" + info_obj[i].userId + "\">" + info_obj[i].userName + "</p>";
                            players += "<p hidden name=\"plst_id\" id=\"plst_id_" + info_obj[i].userId + "\">" + info_obj[i].userId + "</p>";
                            players += "<p hidden id=\"plst_img_" + info_obj[i].userId + "\">" + img + "</p>";
                            players += "<p hidden id=\"plst_lvl_" + info_obj[i].userId + "\">" + info_obj[i].level + "</p>";
                            players += "<p hidden id=\"plst_gR_" + info_obj[i].userId + "\">" + info_obj[i].gRound + "</p>";
                            players += "<p hidden id=\"plst_gWR_" + info_obj[i].userId + "\">" + info_obj[i].gWRound + "</p>";
                            players += "<p hidden id=\"plst_gWSR_" + info_obj[i].userId + "\">" + info_obj[i].gWSRound + "</p>";
                            players += "</div></li>";

                        }
                        players += "</ul>";
                        $("player_list").innerHTML = players;
                        if (info_obj.length == $("player_num").innerHTML && $("stage").value == "I") {
                            if (getRequestFromUrl("roomId") == "") {
                                var herf = $("owner_control");
                                herf.removeAttribute("hidden");
                            }
                            $("stage").value = "S";
                        }
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }


    function iniGame() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/IniGameController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            var playerNum = $("player_num").innerHTML;
            var difficulty = $("difficulty").innerHTML;
            if (roomId != "" && playerNum != "" && difficulty != "") {
                data = "roomId=" + roomId + "&playerNum=" + playerNum + "&difficulty=" + difficulty;

            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        if (info_obj.status == "D") {
                            $("stage").value = "S";
                        }
                        //$("start_game").setAttribute("hidden", "");
                        $("owner_control").setAttribute("hidden", "");

                    }
                }
            };
            HttpXmlObject.send(data);
        }
    }


    function isStart() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/Module1.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "") {
                data = "roomId=" + roomId;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        if (info_obj.status == "D") {
                            var words = "";
                            if (info_obj.isSpy == "S") {
                                words += info_obj.sWord;
                                $("assigned_word").innerHTML = info_obj.nWord;
                                //$("other_word").value = info_obj.nWord;
                            } else {
                                words += info_obj.nWord;
                                $("assigned_word").innerHTML = info_obj.sWord;
                                //$("other_word").value = info_obj.sWord;
                            }
                            if ($("is_reveal").innerHTML == "U") {
                                if(info_obj.isSpy == "S"){
                                    words += "(you are the spy!)";
                                }
                            }
                            $("identity").value = info_obj.isSpy;
                            //$("given_word").value = words;
                            $("stage").value = "D";
                            //$("game_area").removeAttribute("hidden");
                            $("assigned_word").removeAttribute("hidden");

                        }
                    }
                }
            };
            HttpXmlObject.send(data);
        }
    }


    function canISpeak() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/RightToSpeakController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "") {
                data = "roomId=" + roomId;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        if (info_obj.canTalk == "A") {
                            $("stage").value = "A";
                            $("send_btn").removeAttribute("hidden");
                            $("user_input").removeAttribute("readonly");
                            //$("talk_area").removeAttribute("hidden");
                        }else if($("myStatus").value == "D"){
                            $("stage").value = "A";
                        }
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }


    function sendMess() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/SendMessageController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            var content = $("user_input").value;
            content = content.trim();
            if (roomId != "") {
                data = "roomId=" + roomId + "&content=" + content;
                //alert(data);
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        if (info_obj.isSucc == "S") {
                            var selfId = info_obj.userId;
                            var imgId = "plst_img_" + selfId;
                            var imgPath = $(imgId).innerHTML;
                            var date = getDate();
                            var userName = $("plst_name_" + selfId).innerHTML;

                            var displayBoard = $("display_board");

                            var formerText = displayBoard.innerHTML;

                            var updateText = htmlDisplayMess(selfId,userName,content,date,imgPath);

                            var completeText = formerText + updateText;
                            displayBoard.innerHTML = completeText;
                            $("send_btn").setAttribute("hidden", "");
                            $("user_input").removeAttribute("onkeydown");
                            $("user_input").value = "";
                            $("user_input").setAttribute("readonly","readonly");
                            /*var mess = info_obj.userId;
                            mess += " (" + date + ") :\r\n";
                            mess += "&#09;" + content + "\r\n";
                            var chatBox = $("chat_box").innerHTML;
                            chatBox += mess;
                            $("chat_box").innerHTML = chatBox;
                            $("chat_box").scrollTop = $("chat_box").scrollHeight;
                            $("talk_area").setAttribute("hidden", "");*/
                        }
                    }
                }
            };
            HttpXmlObject.send(data);
        }
    }


    function canVote() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/CanVoteController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "") {
                data = "roomId=" + roomId;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        $("stage").value = "V";
                        if($("myStatus").value != "D"){
                            var activePlayerList = document.getElementsByName("active_player");
                            for (var i = 0; i < activePlayerList.length; i++) {
                                var candidate = activePlayerList[i].id;
                                candidate = candidate.replace("p_","");
                                activePlayerList[i].setAttribute("class","active");
                                activePlayerList[i].setAttribute("onclick","doVote(\'" + candidate + "\')");
                            }

                            var imgPath = "pic/welcome.jpg";
                            var date = getDate();

                            var displayBoard = $("display_board");

                            var formerText = displayBoard.innerHTML;

                            var content = "Now you can choose one player to Vote on the player list!!!";

                            var updateText = htmlDisplayMess("system","@System",content,date,imgPath);

                            var completeText = formerText + updateText;
                            displayBoard.innerHTML = completeText;
                        }
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }


    function doGetMess() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/GetMessageController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "") {
                data = "roomId=" + roomId;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        for (var i = 0; i < info_obj.length; i++) {

                            var userId = info_obj[i].sender;
                            var imgId = "plst_img_" + userId;
                            var imgPath = $(imgId).innerHTML;
                            var date = info_obj[i].sendTime;
                            var displayBoard = $("display_board");
                            var formerText = displayBoard.innerHTML;
                            var content = info_obj[i].content;
                            var userName = $("plst_name_" + userId).innerHTML;

                            var updateText = htmlDisplayMess(userId,userName,content,date,imgPath);

                            var completeText = formerText + updateText;
                            displayBoard.innerHTML = completeText;
                            displayBoard.scrollTop = displayBoard.scrollHeight;
                            var meId = info_obj[0].receiver;
                            var myStatus = $("myStatus");
                            myStatus.setAttribute("name",meId);

                            /*var message = info_obj[i].sender + " (" + info_obj[i].sendTime + ") : \r\n";
                            message += "&#09;" + info_obj[i].content + "\r\n";
                            var chatBox = $("chat_box");
                            var app =chatBox.innerHTML;
                            app += message;
                            chatBox.innerHTML = app;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            var me = info_obj[0].receiver;
                            var myStatus = $("me");
                            myStatus.setAttribute("name",me); */
                        }
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }


    /**
     *
     * @param candidate
     */
    function doVote(candidate) {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/VoteController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "" && candidate != "") {
                data = "roomId=" + roomId + "&candidate=" + candidate;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");

                        $("stage").value = info_obj.status;
                        var activePlayerList = document.getElementsByName("active_player");
                        for(var i=0; i < activePlayerList.length; i++){
                            activePlayerList[i].setAttribute("class","default");
                        }
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }

    function allVoted(){
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/CheckAllVotedController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            var playerNum = $("player_num").innerHTML;
            if (roomId != "" && playerNum != "") {
                data = "roomId=" + roomId + "&playerNum=" + playerNum;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        $("stage").value = info_obj.status;
                    }
                }
            }
            HttpXmlObject.send(data);
        }
    }


    function doGetResult() {
        var HttpXmlObject = getXmlHttpObject();
        if (HttpXmlObject) {
            var url = "../Controller/GetResultController.php";
            var data = "";
            var roomId = $("room_id").innerHTML;
            if (roomId != "") {
                data = "roomId=" + roomId;
            }
            HttpXmlObject.open("post", url, true);
            HttpXmlObject.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            HttpXmlObject.onreadystatechange = function () {
                if (HttpXmlObject.readyState == 4) {
                    if (HttpXmlObject.status == 200) {
                        var info = HttpXmlObject.responseText;
                        var info_obj = eval("(" + info + ")");
                        var result = info_obj.result;
                        var results = result.split(" ");
                        var dead = results[0];
                        var identity = results[1];
                        var isWin = results[2];
                        if(dead == "NONE"){
                            var content = "No one die tonight.";
                        }else{
                            var li = $("p_" + dead);
                            li.setAttribute("name","dead_player");
                            if(dead == $("myStatus").name){
                                $("myStatus").value = "D";
                            }
                            var isSpy = $("identity").value;
                            var content = dead + " is dead";
                            if($("is_reveal").innerHTML == "U"){
                                content += " He/she is " + identity + ".";
                            }
                        }
                        if(isWin == "T"){
                            content += " Next Round!!"
                        }else{
                            if(isWin == isSpy){
                                content += " You are the winner!!";
                            }else{
                                content += " You lose!";
                            }
                        }
                        var imgPath = "pic/welcome.jpg";
                        var date = getDate();
                        var displayBoard = $("display_board");
                        var formerText = displayBoard.innerHTML;
                        updateText = htmlDisplayMess("system","@System",content,date,imgPath);
                        var completeText = formerText + updateText;
                        displayBoard.innerHTML = completeText;
                        displayBoard.scrollTop = displayBoard.scrollHeight;
                        $("stage").value = info_obj.status;

                        /*var mess = "sys";
                        mess += " ( " + date + " ) :\r\n";
                        mess += "&#09;" + content + "\r\n";
                        var chatBox = $("chat_box").innerHTML;
                        chatBox += mess;
                        $("chat_box").innerHTML = chatBox;
                        $("chat_box").scrollTop = $("chat_box").scrollHeight;*/
                    }
                }
            };
            HttpXmlObject.send(data);
        }
    }

    window.setInterval("dispatcher()", 5000);

    function dispatcher() {
        var gameStage = $("stage").value;
        if (gameStage == "I") {
            getPlayerList();
        } else if (gameStage == "S") {
            isStart();
        } else if (gameStage == "D") {
            canISpeak();
            doGetMess();
        } else if (gameStage == "A") {
            doGetMess();
            canVote();
        } else if(gameStage == "V"){
            allVoted();
        } else if(gameStage == "R"){
            doGetResult();
        }
    }


    function keySend(event) {
        //alert("asda");
        var key = event.code;
        if(key == "Enter"){
            sendMess();
        }
    }
</script>
</head>
<body onload="getRoomInfo();setSize();checkIllegalLogin('Charmber')">
<div id="help_menu">
      <div id="ensconce">
              <img id="help_img" src="pic/help.png" alt="">
      </div>
      <div id="open">
          <div class="navH">
            <h4> The game rules</h4>
              <span><img class="obscure" src="pic/obscure.png" alt=""></span>
          </div>
          <div class="navBox">
              <ul>
                  <li>Every one will</li>
                  <li></li>
                  <li></li>
                  <li></li>
                  <li></li>
              </ul>
          </div>
      </div>
</div>
<div id="size">
    <div id="global_status" hidden>
        <input type="test" id="stage" value="">
        <input type="test" id="myStatus" value="A">
        <input type="test" id="identity" value="">
        <table>
            <tr>
                <th>Room ID</th>
                <td id="room_id"></td>
            </tr>
            <tr>
                <th>Room Type</th>
                <td id="room_type"></td>
            </tr>
            <tr>
                <th>Game Mode</th>
                <td id="is_reveal"></td>
            </tr>
            <tr>
                <th>Difficulty</th>
                <td id="difficulty"></td>
            </tr>
            <tr>
                <th>Player Number</th>
                <td id="player_num"></td>
            </tr>
        </table>
    </div>

    <div id="app">
        <div class="sidebar">
            <div class="card">
                <div class="header">
                    <img id="room_owner" src="pic/welcome.JPG" alt="">
                    <p id="owner_name">@owner</p>
                    <p id="owner_id" hidden>@owner</p>
                    <div class="owner_control" hidden id="owner_control">
                        <input type="button" name="button" class="btn btn-link" value="StartGame" id="start_game" onclick="iniGame()">
                    </div>
                    <div class="owner_control" hidden id="assigned_word">
                    </div>
                </div>
            </div>
            <div class="player_list" id="player_list">
                <ul>
                    <li id="player_" >
                        <div hidden>
                            <input type="text" id="" status="">
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main">
            <div class="message">
                <ul id="display_board">
                    <li>
                        <p class="system" id="sys_info">
                            <span id="room_info">Welcome!</span>
                        </p>
                    </li>
                </ul>
            </div>
            <div class="text">
                <textarea id="user_input" name="textarea" rows="8" cols="80" onkeydown="keySend(event)" readonly="readonly"></textarea>
                <input hidden type="button" id="send_btn" onclick="sendMess()" value="send(Enter)">
            </div>
            <!--<input hidden type="button" id="send_btn" onclick="sendMess()" value="send">-->
        </div>
    </div>

</div>
</body>
<!--<body onload="getRoomInfo()">


<br/>
<input type="button" id="start_game" hidden value="start game" onclick="iniGame()">
<input type="button" id="next_round" hidden value="next round" onclick="iniGame()">
<div id="vote">

</div>
<div id="game_area" hidden>
    word:<input type="text" id="given_word" value="">
    <input type="hidden" id="other_word" value=""><br/><br/>
    <textarea cols="40" rows="10" id="chat_box"></textarea><br/><br/>
    <div id="talk_area" hidden>
        <input type="text" id="content" name="content" value="">
        <input type="button" value="send" onclick="sendMess()"/>
    </div>
</div>
</body>-->
</html>
